<!doctype html>
<html lang="en">
  <head>
    <title>Map Viewer | CitySDK Linked Data API</title>
    <meta charset="utf-8">
    <meta name="viewport"content="width=device-width,initial-scale=1">
    <link href="/img/favicon.ico" rel="shortcut icon" type=image/x-icon>
	  <link rel="stylesheet" type="text/css" href="/css/kickstart.css" media="all" />
    <link rel="stylesheet" type="text/css" href="/css/style.css" media="all" />
    <script src="/js/jquery-1.9.1.min.js"></script>
    <script src="/js/jquery-migrate-1.2.1.min.js"></script>
    <script type="text/javascript" src="/js/kickstart.js"></script>

    

    
    <script src="/js/highlight.min.js"></script>
    <script src="/js/leaflet.js"></script>
    <!--[if lt IE 9]><script src="http://html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
    <link rel="stylesheet" href="/css/leaflet.css" />
    <link rel="stylesheet" href="/css/map.css">

    <script src="/js/spin.min.js"></script>
    

	  <link href="//fonts.googleapis.com/css?family=Ubuntu:300italic,300,400italic,400,500italic,500,700italic,700" rel="stylesheet" type="text/css">

  </head>
  <body>
  	<div class="grid gridhome">
  		<div class="col_12 ">
  			<div class="rhnav">
  				<div class="col_12">
  					<div class="col_8">
  						<a href="/"><img src="/img/citysdk.png" class="imgextramarge" ></a>
  					</div>
  				</div>
          <div class="col_12" >
	<ul class="menu extramarge">
  
    
    <!--  -->

    
    
    <li >
      <a href="/">Home</a>
    </li>
    
    </li>
  
    
    <!-- 
      

      

      

      
     -->

    
      <li>
      <a href="#">Getting Started</a>
      <ul>
      
        <li><a href="/documentation">Documentation</a></li>
      
        <li><a href="/app-gallery">App Gallery</a></li>
      
        <li><a href="/api-key">API Key</a></li>
      
      </ul>
    </li>
    
    </li>
  
    
    <!-- 
      

      

      
     -->

    
      <li>
      <a href="#">Data</a>
      <ul>
      
        <li><a href="/map">Map Viewer</a></li>
      
        <li><a href="/data">Data</a></li>
      
      </ul>
    </li>
    
    </li>
  
    
    <!--  -->

    
    
    <li >
      <a href="/faq">FAQ</a>
    </li>
    
    </li>
  
    
    <!--  -->

    
    
    <li >
      <a href="/contact">Contact</a>
    </li>
    
    </li>
  
</div>
  			</div>
  			<hr/>

  <div id="map-url-input">
 <table>
   <tr>
     <td class="minimize endpoint">
       http://api.citysdk.waag.org/
     </td>
     <td class="fill">
       <input id="url" type="text" />
     </td>
     <td class="minimize">
       <div id="busy"></div>
     </td>
     <td class="minimize">
       <button id="show-dropdown" type="button" class="button_down"></button>
     </td>
   </tr>
   <tr class="hidden" id="before_history"></tr>
   <tr class="hidden" id="before_examples"></tr>
 </table>
</div>

<div id="map-container">
  <div id="map"></div>
  <div id="floatbox">
    <code id="nodedata">Enter a CitySDK URL or choose an example URL from the drop-down list to view CitySDK API data.</code>
  </div>
</div>
<script>
  $(document).ready(function() {

    var endpoint  = "http://api.citysdk.waag.org/",
        tileUrl = "http://tiles.citysdk.waag.org/v2/citysdk/{z}/{x}/{y}.png",
        latLng = [52.35, 5.39],
        zoom = 10;

    //hljs.initHighlightingOnLoad();

    var spinnerOpts = {
      lines: 12, // The number of lines to draw
      length: 4, // The length of each line
      width: 1, // The line thickness
      radius: 3, // The radius of the inner circle
      corners: 1, // Corner roundness (0..1)
      rotate: 0, // The rotation offset
      direction: 1, // 1: clockwise, -1: counterclockwise
      color: '#111', // #rgb or #rrggbb
      speed: 1, // Rounds per second
      trail: 60, // Afterglow percentage
      shadow: false, // Whether to render a shadow
      hwaccel: false, // Whether to use hardware acceleration
      className: 'spinner', // The CSS class to assign to the spinner
      zIndex: 2e9, // The z-index (defaults to 2000000000)
      left:5,
      top: 0
      };
    var spinner = new Spinner(spinnerOpts)

    var map = L.map('map');

    var disableHashChange = false;
    var latLongLargeShown = false;
    var urlHistory = []; // Keep list of used URLs to show in drop down menu.
    var currentURL = "";

    // ================================================================================
    // Leaflet map initialization
    // ================================================================================

    var osmAttrib = 'Map data Â© OpenStreetMap contributors';

    // Base maps ===============

    var tileLayer = new L.TileLayer(tileUrl, {
      minZoom: 4, maxZoom: 18,
      opacity: 1,
      attribution: osmAttrib
    }).addTo(map);

    var lineStyle = {
      color: "#CE2027",
      weight: 3,
      opacity: 0.90
    };

    var pointStyle = {
      radius: 5,
      //fillColor: "#ed7cff",
      //color: "#000000",
      weight: 1,
      opacity: 1,
      fillOpacity: 0.9
    };

    function onFeatureClick(e) {
      feature = e.target.feature;
      setNodeData(feature.properties);
    }

    function onEachFeature(feature, layer) {
      layer.on('click', onFeatureClick);
    }

    var cdkLayer = new L.geoJson(null, {
      style: lineStyle,
      onEachFeature: onEachFeature,
      pointToLayer: function (feature, latlng) {
        return L.circleMarker(latlng, pointStyle);
      }
    }).addTo(map);

    map.setView(latLng, zoom);

    // ================================================================================
    // CitySDK API data
    // ================================================================================

    function loadCitySDKData(url, isExample) {
      hideDropdown();

      if (!url) {
        return;
      }

      // Sometimes you want to refresh to (real-time) data
      // by resubmitting same url...
      // Turn check for new url off for now!
      // if (!url || url == currentURL) {
      //   return;
      // }
      //currentURL = url;

      var historyUrl = url;

      disableHashChange = true;
      window.location.hash = url;

      spinner.spin(document.getElementById('busy'))

      var http = 'http://',
          https = 'https://';

      if (url.substring(0, http.length) !== http && url.substring(0, https.length) !== https) {
        url = endpoint + url;
      }
      url += (url.split('?')[1] ? '&':'?') + 'geom';
      if( url.indexOf("per_page") == -1 ) {
        url += '&per_page=100';
      }

      cdkLayer.clearLayers();

      // TODO: also reject if request times out!
      $.getJSON(url, function(data) {
        // If data is returned, and data.results.length > 0,
        // add URL to urlHistory
        if ((data.results.length > 0) &! isExample) {
          addHistory(historyUrl);
          setDropdownHistory();
        }

         for (var i = 0; i < data.results.length; i++) {
           var node = data.results[i];

           if(node.geom) {
             var geom = node.geom
             delete node["geom"];
             var feature = {
               type: "Feature",
               properties: node,
               geometry: geom
             };
           } else if(node.bbox) {
             var geom = node.bbox
             delete node["bbox"];
             var feature = {
               type: "Feature",
               properties: node,
               geometry: geom
             };

           } else {
             continue;
           }
           cdkLayer.addData(feature);
         }
         formatResult(data);

         spinner.stop();

         /*
         We want to fit all the data on the map.
         Normally, map.fitBounds(cdkLayer.getBounds())
         would do. But the floatbox is obscuring part
         of the map.
         We must calculate the bounds of the data
         and resize the width to include floatbox width
         */

         var dataBounds = cdkLayer.getBounds();
         var southWest = dataBounds.getSouthWest();
         var northEast = dataBounds.getNorthEast();
         // TODO: Dit is dus NIET goed. Ik moet hier nog 'ns even goed over na gaan denken. Nu naar bed. Daag!

         var lngScale = $("#map").width() / (($("#map").width() - ($("#floatbox").width() + 30)));

         map.fitBounds([
             [southWest.lat, southWest.lng],
             [northEast.lat, (northEast.lng - southWest.lng) * lngScale + southWest.lng]
         ]);

       }).fail(function(e) {
         if(e.responseText)
		   {
		   		var data = $.parseJSON(e.responseText);
               	formatResult(data)
             }
		   else
		   {
				$('#nodedata').html("unknown error (maybe server is unavailable / maybe the requested was not formatted correctly)")
		   }
		   spinner.stop();
     });

    }

    $("#url").keyup(function(event) {
      if(event.keyCode == 13){
        var url = $("#url").val();
        loadCitySDKData(url, false);
      }
    });

    function formatResult(result) {
      setNodeData(result);
    }

    function setNodeData(json) {
      $('#nodedata').html(JSON.stringify(json, undefined, 2));
      $('#nodedata').each(function(i, e) {hljs.highlightBlock(e)});
    }

    // ================================================================================
    // Load #hash url on page load
    // ================================================================================

    window.onhashchange = function() {
      if (!disableHashChange) {
        var hash = window.location.hash;
        if (hash.length > 1) {
          var url = hash.substring(1);
          if (url.substring(0, endpoint.length) == endpoint) {
            $("#url").val(url.substring(endpoint.length + 1));
          } else {
            $("#url").val(url);
          }
          loadCitySDKData(url, false);
        }
      }
      disableHashChange = false;
    }

    // Call functions on page load:
    window.onhashchange();
    //window.onresize();
    $('#url').focus();

    // ================================================================================
    // Combobox functions
    // ================================================================================

    $('td.endpoint').click(function() {
      $('#url').focus();
    });

    $("#show-dropdown").click(function() {
      var n = $("tr.dropdown.hidden").length;
      if (n > 0) {
        showDropdown();
      } else {
        hideDropdown();
      }
    });

    $("#map-url-input table").on("click", "tr.dropdown", function(event){
      var url = $(this).attr("data-url");
      var isExample = $(this).attr("data-example");
      hideDropdown();
      $("#url").val(url);
      loadCitySDKData(url, isExample === "true");
    });

    $(document).mouseup(function (e) {
      var container = $("tr.dropdown");
      if (!$("#show-dropdown").is(e.target) && container.has(e.target).length === 0) {
        hideDropdown();
      }
    });

    function showDropdown() {
      $(".dropdown").removeClass("hidden");
      setButtonType("#show-dropdown", "up");
    }

    function hideDropdown() {
      $(".dropdown").addClass("hidden");
      setButtonType("#show-dropdown", "down");
    }

    function addDropdownExamples() {

      // Jekyll inserts examples from endpoint.yml:
      // TODO: read examples from examples.json instead!
      var examples = [
        
        {
          url: "admr.nl.amsterdam/nodes?osm::tourism=museum",
          title: "OpenStreetMap museums in Amsterdam"
        },
        
        {
          url: "admr.nl.amsterdam/nodes?layer=artsholland",
          title: "Cultural events in Amsterdam for the next two weeks"
        },
        
        {
          url: "nodes?311.amsterdam::status=open",
          title: "Open311 service requests in Amsterdam"
        },
        
        {
          url: "nodes?layer=rws.nap",
          title: "Waterlevels in millimeters above the Amsterdam Ordnance Datum"
        },
        
        {
          url: "nodes?per_page=250&layer=ns&bbox=53.579461,4.487915,52.069377,7.146606",
          title: "NS stations in the upper half of the Netherlands"
        },
        
        {
          url: "admr.nl.zwolle/regions?admr::admn_level=4&layer=cbs&per_page=50",
          title: "Statistical data of all neighbourhoods in Zwolle"
        },
        
        {
          url: "admr.nl.groningen/regions?admr::admn_level=4&layer=rain",
          title: "Rain forecast per neighbourhood in Groningen"
        },
        
        {
          url: "admr.nl.woerden/ptstops?layer=gtfs",
          title: "Public transport stops in Woerden"
        },
        
        {
          url: "gtfs.stop.15331/select/ptlines",
          title: "Public transport lines that call at Leidseplein, Amsterdam"
        },
        
        {
          url: "routes?layer=divv.traffic&per_page=200",
          title: "Real time traffic flow on main roads in Amsterdam"
        },
        
        {
          url: "r326516/select/nodes?osm::railway=tram_stop|halt&data_op=or",
          title: "Tram stops on Utrecht-IJsselstein tram route"
        },
        
        {
          url: "nodes?2cm.hmp::wegnummer=N200&per_page=300",
          title: "Highway location markers along the N200"
        },
        
        {
          url: "nodes?layer=divv.parking.buildings",
          title: "Public parking in Amsterdam"
        },
        
        {
          url: "admr.nl.amsterdam_stadsdeel_oost_oostelijk_havengebied/nodes?layer=bag.ligplaatsen",
          title: "Houseboat locations in Stadsdeel Oost"
        },
        
        {
          url: "nodes?layer=bag.panden&lat=52.0936&lon=4.3451&per_page=100",
          title: "Buildings from near the Dutch Royal Palace"
        },
        
        {
          url: "admr.nl.alkmaar/nodes?layer=rce.rijksmonumenten",
          title: "Cultural heritage sites in Alkmaar"
        },
        
        {
          url: "nodes?layer=rce.rijksmonumenten,amsterdam.hotels,bag.vbo",
          title: "Hotels in Amsterdam that are also a cultural heritage site"
        },
        
        {
          url: "admr.nl.eindhoven/nodes?layer=nl.risicokaart.*",
          title: "Objects from the Risicokaart in the city of Eindhoven"
        },
        
      ];

      $.each(examples.slice(0).reverse(), function() {
        var tr = "<tr class=\"example hidden dropdown\" data-example=\"true\" data-url=\"" + this.url + "\"><td colspan=\"5\">" + this.title + "</td></tr>";
        //$('#input table').append($(tr));
        $(tr).insertAfter($('#before_examples'));
      });

    }

    function addHistory(url) {
      var index = urlHistory.indexOf(url);
      if (index >= 0) {
        urlHistory.splice(index, 1);
      }
      urlHistory.push(url);

      if (urlHistory.length > 10) {
        urlHistory.shift();
      }
    }

    function setDropdownHistory() {
      $('tr.history').remove();
      $.each(urlHistory.slice(0, -1), function(index) {
        var cls = "history hidden dropdown";
        if (index == 0) {
          cls += " last_history";
        }
        var tr = "<tr class=\"" + cls + "\" data-url=\"" + this + "\"><td class=\"minimize endpoint\">http://api.citysdk.waag.org/</td><td class=\"fill\" colspan=\"4\"><span class=\"url\">" + this + "</span></td></tr>";
        $(tr).insertAfter($('#before_history'));
      });
    }
    addDropdownExamples();
  });

  function setButtonType(selector, type) {
    if (type === "up") {
      $(selector).removeClass("button_down");
      $(selector).addClass("button_up");
    } else { // type === "down"
      $(selector).removeClass("button_up");
      $(selector).addClass("button_down");
    }
  }

	$.ajaxTransport("+*", function( options, originalOptions, jqXHR ) {
    if($.browser.msie && window.XDomainRequest) {
      var xdr;
      return {
        send: function( headers, completeCallback ) {
          // Use Microsoft XDR
          xdr = new XDomainRequest();
          r = Math.round(Math.random() * 1000)
	        xdr.open("get", options.url + "&ienocache=" + r);
	        xdr.onload = function() {
  	        if (this.contentType.match(/\/xml/)){
              var dom = new ActiveXObject("Microsoft.XMLDOM");
  	          dom.async = false;
  	          dom.loadXML(this.responseText);
  	          completeCallback(200, "success", [dom]);
            } else {
              completeCallback(200, "success", [this.responseText]);
            }
          };
          xdr.onprogress = function() {
          };
          xdr.ontimeout = function() {
	          completeCallback(408, "error", ["The request timed out."]);
	        };
          xdr.onerror = function(a,b) {
				    completeCallback(404, "error", ["The requested resource could not be found."]);
          };
	        xdr.send();
        },
	      abort: function() {
	        if(xdr)xdr.abort();
        }
      };
    }
  });

</script>

  </body>
</html>



